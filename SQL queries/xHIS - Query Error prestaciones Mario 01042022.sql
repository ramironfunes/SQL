select distinct vale_asis_det.va_det_pk,
cagendas_prest.actividad_det_pk,
--cagendas_prest.prest_item_pk,
--vale_asis_det.actividad_det_pk,
--vale_asis_det.prest_item_pk,
--distinct vale_asis_det.va_det_pk,
--vale_asis_det.actividad_det_pk,
--cagendas_prest.actividad_det_pk as conf,
--vale_asis_det.actividad_det_pk as fac,
--cagendas_prest.prest_item_pk,
--cagendas_prest.prest_item_pk,
--vale_asis_det.prest_item_pk,
clientes.apellido1 as Apellido1,
CASE
WHEN clientes.apellido2 = '' OR clientes.apellido2 is null THEN ''
ELSE clientes.apellido2 END as Apellido2,
clientes.nombre as Nombre,
hc.nhc as NHC,
episodios.epis_pk as 'Encuentro',
garantes.nombre_garante as 'Garante Conf Cita',
co_planes.plan_desc as 'Plan Conf Cita',
CONVERT (VARCHAR, cagendas.fecha, 5) as 'Fecha Cita',
CONVERT (VARCHAR, cagendas.hora, 8) as 'Hora Cita',
CONVERT (VARCHAR, cagendas.t_llegada, 8) as 'H. Llegada Conf Cita',
fpersona.apellido1 +' '+fpersona.nombre as 'Usuario Carga Cita',
servicios.servicio as 'Servicio Conf Cita',
CASE
WHEN cagendas_prest.cagprest_nchipcard is null THEN ''
ELSE cagendas_prest.cagprest_nchipcard END AS 'Nro Transacci贸n',
--prest_itemConf.prest_item_cod as 'Cod Prestacion Conf Cita',
--prest_itemConf.prest_item_desc as 'Prestacion Conf Cita',
--prest_item.prest_item_cod as 'Cod Prestacion Facturaci贸n',
--prest_item.prest_item_desc as 'Prestacion Facturacion',
vale_asis_det.va_det_cantidad as 'Cantidad',
[dbo].[FN_XHIS_GET_PREST_COD] (cagendas_prest.prest_item_pk) as 'Cod Prestacion Conf Cita',
[dbo].[FN_XHIS_GET_PREST] (cagendas_prest.prest_item_pk) as 'Prestacion Conf Cita',
[dbo].[FN_XHIS_GET_PREST_COD] (vale_asis_det.prest_item_pk) as 'Cod Prestacion Facturaci贸n',
[dbo].[FN_XHIS_GET_PREST] (vale_asis_det.prest_item_pk) as 'Prestacion Facturacion',
--servicios2.servicio as 'Servicio Facturacion',
garantesfac.nombre_garante as 'Garante Facturacion',
co_planesfac.plan_desc as 'Plan Facturacion',
Case
when vale_asis_det.va_det_estado=0 and vale_asis_det.va_det_fact_cob=0 and vale_asis_det.va_det_fact2_cob=0 then 'Anulado'
when vale_asis_det.va_det_estado=1 and vale_asis_det.va_det_fact_cob=0 and vale_asis_det.va_det_fact2_cob=0 then 'Pendiente'
when vale_asis_det.va_det_estado=3 and vale_asis_det.va_det_fact_cob=0 and vale_asis_det.va_det_fact2_cob=0 then 'No Facturable'
when vale_asis_det.va_det_estado=0 and vale_asis_det.va_det_fact_cob=1 or vale_asis_det.va_det_fact2_cob=1 and vale_asis_det.mot_anul_vale_pk=1 then 'Nota de Credito (Anulado)'
when vale_asis_det.va_det_estado=1 and vale_asis_det.va_det_fact_cob=0 and vale_asis_det.va_det_fact2_cob=1 then 'Facturado Financiador'
when vale_asis_det.va_det_estado=1 and vale_asis_det.va_det_fact_cob=1 and vale_asis_det.va_det_fact2_cob=0 then 'Facturado Privado'
end as Estado,
vale_asis_det.va_det_total_fin as 'Precio Financiador',
vale_asis_det.va_det_total_pac as 'Precio Privado',
CONVERT (VARCHAR, vale_asis_det.va_det_fapunte, 5) as 'Fecha Apunte Prefacturacion',
CONVERT (VARCHAR, vale_asis_det.va_det_hora_Apunte, 8) as 'Hora Apunte Prefacturaci贸n'

from vale_asis_det vale_asis_det
right join cagendas_prest cagendas_prest on vale_asis_det.actividad_det_pk = cagendas_prest.actividad_det_pk
inner join vale_asis_cab vale_asis_cab on vale_asis_cab.va_pk = vale_asis_det.va_pk
inner join cex ON vale_asis_det.va_det_referencia = cex.cex_pk
inner join cagendas on cagendas.n_solic = cex.con_cita_sn
inner join fpersona on fpersona.codigo_personal = cagendas.codigo_personal2
inner join co_planes on co_planes.plan_pk = cex.plan_pk
inner join garantes on garantes.codigo_garante_pk = co_planes.codigo_garante_pk
inner join co_planes co_planesfac on vale_asis_cab.plan_pk = co_planesfac.plan_pk
inner join garantes garantesfac on co_planesfac.codigo_garante_pk = garantesfac.codigo_garante_pk
inner join clientes ON clientes.codigo_cliente = cex.codigo_cliente
inner join hc ON hc.codigo_cliente = cex.codigo_cliente
inner join servicios on servicios.codigo_servicio = cagendas.codigo_servicio
INNER JOIN episodios ON episodios.referencia_id=cex.cex_pk --and episodios.tipo_episodio_pk = vale_asis_det.tipo_episodio_pk
inner join prest_item prest_item on prest_item.prest_item_pk=vale_asis_det.prest_item_pk
inner Join prest_item prest_itemConf on prest_itemConf.prest_item_pk = cagendas_prest.prest_item_pk
WHERE (cagendas_prest.prest_item_pk <> vale_asis_det.prest_item_pk)
--where cagendas_prest.actividad_det_pk in (11462397,11463041,11463195) --PRUEBA
AND (vale_asis_det.actividad_pk IS NOT null)
AND cagendas.fecha = '20220401'
and cagendas.t_llegada <= '1900-01-01 17:30:00.000'
--AND cagendas.fecha BETWEEN '20220329' AND '20220330'
--AND episodios.tipo_episodio_pk = 2
--AND vale_asis_det.prest_item_pk not in (select prest_item.prest_item_pk from prest_item prest_item where prest_item.prest_item_cod like 'TNF%')
AND vale_asis_det.prest_item_pk not in ('48214',
'48986',
'53461',
'53452',
'49028',
'53453',
'49000',
'47791',
'53458',
'53459',
'53460',
'53542',
'53543',
'53544',
'53545',
'53546',
'53612',
'53614',
'53617',
'53618',
'53619',
'53621',
'53622',
'53625',
'53626',
'53628',
'53632',
'53633',
'53635',
'49022',
'49019',
'53647',
'53648',
'53649',
'53650',
'49021',
'49020',
'53651',
'53658',
'49014',
'49013',
'53659',
'53660',
'49018',
'53661',
'53665',
'53666',
'53667',
'53669',
'53670',
'53671',
'53672',
'53679',
'49016',
'48992',
'48216',
'48215',
'53680',
'53681',
'53685',
'53686',
'47792',
'49011',
'49010',
'49012',
'49009',
'53687',
'53689',
'53690',
'48989',
'48995',
'48993',
'53692',
'53693',
'53694',
'53695',
'48980',
'53696',
'53699',
'53700',
'49008',
'53701',
'53703',
'53704',
'53709',
'53728',
'53729',
'53757',
'53788',
'53789',
'53790',
'53791',
'53792',
'53795',
'53798',
'53797',
'53805',
'53809',
'53879',
'53880',
'53884',
'53938',
'53940',
'53941',
'53960',
'53968',
'53969',
'53970',
'53981',
'53984',
'53985',
'54005',
'54006',
'54019',
'54070',
'54071',
'54072',
'54073',
'54091',
'54096',
'54122',
'54178',
'54195',
'54197',
'54207',
'48996',
'49036',
'48991',
'48213',
'47793',
'49006',
'49005',
'49004',
'49001',
'47840',
'49031',
'48981',
'49038',
'47837',
'49017',
'48983',
'48982',
'49034',
'49033',
'49035',
'48390',
'48935',
'47788',
'49037',
'48219',
'48514',
'48243',
'48246',
'48244',
'48646',
'48485',
'48489',
'48490',
'48247',
'48405',
'48258',
'48262',
'48941',
'48942',
'48944',
'48945',
'48946',
'48260',
'48252',
'48288',
'48263',
'48647',
'48259',
'48725',
'48503',
'48641',
'48870',
'48520',
'48910',
'48924',
'48251',
'48270',
'48272',
'48271',
'48273',
'48274',
'48923',
'48370',
'48281',
'48248',
'48704',
'48705',
'48933',
'48285',
'48287',
'48286',
'48863',
'48293',
'48289',
'48292',
'48673',
'48290',
'48230',
'48228',
'48676',
'48296',
'48297',
'48298',
'48295',
'48301',
'48300',
'48299',
'48302',
'48303',
'48926',
'48927',
'48657',
'48454',
'48516',
'48506',
'48706',
'48844',
'48842',
'48718',
'48726',
'48716',
'48675',
'48851',
'48856',
'48611',
'48938',
'48304',
'48517',
'48889',
'48507',
'48843',
'48715',
'48847',
'48683',
'48312',
'48890',
'48901',
'48839',
'48857',
'48493',
'48877',
'48701',
'48903',
'48687',
'48668',
'48235',
'48291',
'48648',
'48368',
'48806',
'48279',
'48702',
'48316',
'48894',
'48487',
'48486',
'48640',
'48666',
'48639',
'48561',
'48608',
'48664',
'48570',
'48475',
'48379',
'48614',
'48615',
'48521',
'48532',
'48579',
'48598',
'48536',
'48599',
'48610',
'48633',
'48581',
'48606',
'48576',
'48559',
'48616',
'48554',
'48636',
'48628',
'48557',
'48555',
'48607',
'48549',
'48565',
'48543',
'48564',
'48573',
'48542',
'48593',
'48527',
'48621',
'48572',
'48583',
'48566',
'48617',
'48574',
'48601',
'48612',
'48622',
'48897',
'48550',
'48591',
'48537',
'48635',
'48560',
'48634',
'48589',
'48556',
'48618',
'48545',
'48597',
'48609',
'48547',
'48625',
'48604',
'48627',
'48613',
'48571',
'48539',
'48541',
'48558',
'48567',
'48531',
'48552',
'48533',
'48311',
'48588',
'49003',
'48551',
'48637',
'48568',
'48582',
'48600',
'48623',
'48534',
'48602',
'48638',
'48544',
'48626',
'48538',
'48553',
'48603',
'48592',
'48624',
'48632',
'48491',
'48578',
'48562',
'48586',
'48577',
'48310',
'48307',
'48308',
'48309',
'48619',
'48535',
'48631',
'48530',
'48563',
'48580',
'48232',
'48667',
'49007',
'48669',
'48415',
'48413',
'48234',
'48233',
'48845',
'48512',
'48849',
'48365',
'48318',
'48319',
'48317',
'48846',
'48321',
'48237',
'48320',
'48764',
'48920',
'48712',
'48838',
'48929',
'48222',
'48523',
'48524',
'48322',
'48323',
'48324',
'48335',
'48331',
'48332',
'48333',
'48334',
'48342',
'48341',
'48336',
'48328',
'48327',
'48329',
'48330',
'48339',
'48326',
'48345',
'48346',
'48340',
'48892',
'48325',
'48630',
'48569',
'48594',
'48348',
'48347',
'47839',
'48350',
'48871',
'48402',
'48822',
'48837',
'48356',
'48352',
'48869',
'48354',
'48464',
'48465',
'48463',
'48355',
'48225',
'48238',
'48713',
'48459',
'48461',
'48371',
'48231',
'48269',
'48267',
'48686',
'48884',
'48659',
'48478',
'48268',
'48266',
'48474',
'48276',
'48275',
'48278',
'48499',
'48696',
'48652',
'48662',
'48661',
'48660',
'48473',
'48472',
'48282',
'48518',
'48658',
'48670',
'48672',
'48679',
'48663',
'48227',
'48469',
'48306',
'48476',
'48800',
'48899',
'48695',
'48728',
'48714',
'48720',
'48462',
'48642',
'48731',
'48736',
'48735',
'48831',
'48830',
'48788',
'48787',
'48656',
'48467',
'48466',
'48508',
'48519',
'48450',
'48522',
'48471',
'48876',
'48874',
'48875',
'48808',
'48792',
'48357',
'48651',
'48358',
'48359',
'48360',
'48361',
'48769',
'48776',
'48819',
'48755',
'48749',
'48740',
'48821',
'48826',
'48239',
'48362',
'48780',
'48781',
'48802',
'48750',
'48751',
'48746',
'48363',
'48777',
'48748',
'48836',
'48809',
'48759',
'48744',
'48783',
'48798',
'48784',
'48367',
'48767',
'48789',
'48840',
'48887',
'48864',
'48727',
'48283',
'48848',
'48768',
'48774',
'48773',
'48775',
'48745',
'48796',
'48671',
'48674',
'48771',
'48585',
'48739',
'48797',
'48437',
'48240',
'48893',
'48483',
'48481',
'48482',
'48460',
'48709',
'48502',
'48226',
'48224',
'48711',
'48401',
'48898',
'48470',
'48733',
'48865',
'48515',
'48841',
'48729',
'48730',
'48732',
'48853',
'48644',
'48940',
'48653',
'48832',
'48738',
'48394',
'48242',
'48645',
'48376',
'48866',
'48377',
'48916',
'48378',
'48883',
'48380',
'48862',
'48431',
'48372',
'48374',
'48835',
'48922',
'48921',
'48859',
'48858',
'48314',
'48315',
'48366',
'48419',
'48500',
'48220',
'48387',
'48685',
'48761',
'48494',
'48495',
'48496',
'48375',
'48742',
'48886',
'48880',
'48382',
'48381',
'48428',
'48429',
'48384',
'48385',
'48383',
'48504',
'48707',
'48795',
'48386',
'48373',
'48913',
'48477',
'48708',
'48907',
'48925',
'48388',
'48389',
'48850',
'48391',
'48682',
'48855',
'48911',
'48392',
'48393',
'48861',
'48867',
'48655',
'48654',
'48908',
'48513',
'48860',
'48364',
'48691',
'48353',
'48509',
'48511',
'48277',
'48497',
'48400',
'48397',
'48719',
'48221',
'48399',
'48879',
'48896',
'48997',
'48479',
'48998',
'48313',
'48710',
'48408',
'48406',
'48410',
'48412',
'48411',
'48414',
'48930',
'48416',
'48699',
'48881',
'48882',
'48417',
'48398',
'48418',
'48421',
'48420',
'48717',
'48468',
'48423',
'48425',
'48427',
'48424',
'48426',
'48434',
'48432',
'48931',
'48436',
'48422',
'48734',
'48403',
'48404',
'48852',
'48678',
'48677',
'48762',
'48753',
'48763',
'48438',
'48439',
'48440',
'48932',
'48525',
'48241',
'48435',
'48433',
'48703',
'48949',
'48441',
'48442',
'48812',
'48934',
'48484',
'48351',
'48443',
'48643',
'48823',
'48444',
'48446',
'48447',
'48448',
'48900',
'48885',
'48650',
'48854',
'48895',
'48649',
'48697',
'48698',
'48449',
'48905',
'48904',
'48451',
'48818',
'48906',
'48816',
'48229',
'48505',
'48455',
'48510',
'48723',
'48724',
'48453',
'48452',
'48456',
'48919',
'48918',
'48395',
'48721',
'48947',
'48369',
'48396',
'48700',
'48909',
'48722',
'48891',
'48457',
'48878',
'48873',
'48872',
'48694',
'48692',
'48868',
'48480',
'48888',
'48445',
'48681',
'48743',
'48827',
'48807',
'48779',
'48813',
'48804',
'48794',
'48754',
'48765',
'48756',
'48747',
'48770',
'48786',
'48689',
'48688',
'48778',
'48829',
'48793',
'48791',
'48820',
'48772',
'48758',
'48757',
'48814',
'48752',
'48218',
'48217',
'48060',
'48062',
'47869',
'48063',
'48056',
'48055',
'47865',
'48058',
'48057',
'48053',
'47868',
'47950',
'47956',
'47955',
'47938',
'47903',
'48171',
'48110',
'48207',
'48152',
'48173',
'48109',
'48206',
'48205',
'48204',
'48203',
'48202',
'48201',
'48200',
'48151',
'48155',
'48158',
'48184',
'48197',
'48103',
'48101',
'48100',
'48099',
'48098',
'48097',
'48096',
'48095',
'48094',
'48093',
'48092',
'48091',
'48090',
'48102',
'48089',
'48144',
'48143',
'48179',
'48178',
'48142',
'48141',
'48163',
'48162',
'48136',
'48133',
'48128',
'48127',
'48123',
'48116',
'47997',
'47995',
'47992',
'47988',
'47984',
'48081',
'48080',
'48079',
'48078',
'48077',
'48076',
'48075',
'48074',
'48073',
'48072',
'48071',
'48070',
'48069',
'48068',
'48067',
'48066',
'48065',
'48064',
'48987',
'48990',
'47804',
'47801',
'47802',
'47803',
'47811',
'47809',
'47807',
'47814',
'47816',
'47817',
'47813',
'47812',
'47808',
'47820',
'47819',
'47806',
'47818',
'47815',
'47836',
'47800',
'47799',
'47796',
'47797',
'47798',
'47822',
'47823',
'47824',
'47826',
'47825',
'47821',
'47795',
'47794',
'47835',
'47832',
'47831',
'47834',
'47828',
'47827',
'47829',
'53423',
'54098',
'48975',
'48972',
'48950',
'48956',
'48957',
'48958',
'48951',
'48963',
'48966',
'48968',
'48962',
'48967',
'48964',
'48959',
'48965',
'48969',
'48971',
'48973',
'48978',
'48979',
'48974',
'48960',
'48961',
'48952',
'48955',
'48953',
'48954',
'48970',
'48976',
'48977',
'47833',
'47810',
'47805',
'48936',
'48937',
'48430',
'47789',
'48834',
'48250',
'48917',
'48249',
'48912',
'48693',
'48575',
'48546',
'48587',
'48629',
'48590',
'48605',
'48595',
'48540',
'48596',
'48548',
'48760',
'48223',
'48338',
'48337',
'48343',
'48680',
'48528',
'48529',
'48498',
'48526',
'48741',
'48236',
'48785',
'48810',
'48805',
'48803',
'48801',
'48790',
'48766',
'48782',
'48824',
'48928',
'48815',
'48828',
'48825',
'48799',
'48914',
'48948',
'48939',
'48690',
'48407',
'48817',
'48501',
'48811',
'47790',
'48284',
'48349',
'48212',
'48059',
'47877',
'47876',
'47875',
'47874',
'47873',
'47872',
'47871',
'47870',
'47878',
'47893',
'47892',
'47891',
'47890',
'47889',
'47888',
'47887',
'47886',
'47885',
'47884',
'47883',
'47882',
'47881',
'47880',
'47879',
'47916',
'47915',
'47914',
'47913',
'47912',
'47911',
'47910',
'47909',
'47908',
'47907',
'47906',
'47905',
'47904',
'47902',
'47901',
'47900',
'47899',
'47898',
'47897',
'47896',
'47895',
'47894',
'47942',
'47941',
'47940',
'47939',
'47937',
'47936',
'47935',
'47934',
'47933',
'47932',
'47931',
'47930',
'47929',
'47928',
'47927',
'47926',
'47925',
'47924',
'47923',
'47922',
'47921',
'47920',
'47919',
'47918',
'47917',
'47948',
'47947',
'47946',
'47945',
'47944',
'47943',
'47949',
'47953',
'47952',
'47951',
'47954',
'47957',
'47959',
'48011',
'47962',
'47969',
'47968',
'47967',
'47966',
'47965',
'47971',
'47970',
'47982',
'48022',
'48020',
'48019',
'48017',
'48015',
'48014',
'48010',
'48007',
'48006',
'48004',
'48002',
'47981',
'47979',
'47978',
'47977',
'47975',
'48045',
'48044',
'48043',
'48052',
'48211',
'48084',
'48083',
'48082',
'48199',
'48198',
'48104',
'48188',
'48187',
'48209',
'48208',
'48108',
'48107',
'48106',
'48105',
'48088',
'48087',
'48086',
'48085',
'48192',
'48191',
'48193',
'48190',
'48189',
'48140',
'48139',
'48146',
'48145',
'48147',
'48150',
'48149',
'48154',
'48153',
'48157',
'48156',
'48159',
'48160',
'48161',
'48165',
'48164',
'48167',
'48195',
'48170',
'48172',
'48175',
'48176',
'48174',
'48177',
'48181',
'48180',
'48148',
'48185',
'49024',
'48458',
'48984',
'48985',
'49026',
'49023',
'48061',
'48943',
'49030',
'47842',
'49025',
'48994',
'49027',
'49029',
'49002',
'48988',
'47830',
'49015',
'48999',
'47838',
'48183',
'48492',
'48684',
'48915',
'48665',
'48280',
'48253',
'48265',
'48264',
'48488',
'48833',
'48737',
'48305',
'48902',
'48013',
'48000',
'47844',
'47845',
'47846',
'47847',
'47848',
'47849',
'47850',
'47851',
'47852',
'47853',
'47854',
'47855',
'47856',
'47857',
'47858',
'47859',
'47860',
'47861',
'47862',
'47863',
'53769',
'47843',
'48054',
'47864',
'47867',
'47866',
'48261',
'48254',
'48255',
'48256',
'48257',
'48245',
'47841',
'47961',
'47964',
'47973',
'48024',
'48026',
'48027',
'48028',
'48029',
'48030',
'48031',
'48032',
'48034',
'48035',
'48037',
'48038',
'48039',
'48041',
'48042',
'48047',
'48049',
'48051',
'48294',
'48194',
'48111',
'48168',
'48169',
'48182',
'48186',
'48196',
'48210',
'49045',
'49046',
'49047',
'49048',
'49049',
'49050',
'49051',
'49052',
'49053',
'49054',
'49055',
'49056',
'49057',
'49058',
'49059',
'49060',
'49061',
'49062',
'49063',
'49064',
'49065',
'49066',
'49067',
'49068',
'49070',
'49072',
'49074',
'49076',
'49078',
'49079',
'49080',
'49082',
'49084',
'49086',
'49088',
'49090',
'49092',
'49094',
'49096',
'49098',
'49100',
'49101',
'49102',
'49104',
'49106',
'49108',
'49110',
'49112',
'49114',
'49116',
'49118',
'49119',
'49120',
'49122',
'49124',
'49126',
'49128',
'49129',
'49130',
'49131',
'49132',
'49134',
'49136',
'49137',
'49138',
'49139',
'49140',
'49141',
'49142',
'49143',
'49144',
'49145',
'49146',
'49147',
'49148',
'49149',
'49150',
'49151',
'49152',
'49153',
'49155',
'49157',
'49159',
'49161',
'49162',
'49163',
'49165',
'49167',
'49169',
'49171',
'49173',
'49174',
'49177',
'49179',
'49181',
'49182',
'49183',
'49032')
AND vale_asis_det.va_det_estado != 3
AND vale_asis_det.va_det_hora_Apunte < dateadd(MINUTE, +1, cagendas.t_llegada)
--AND servicios.codigo_servicio = '42' -- Filtro Lboratorio NO
--AND garantes.codigo_garante_pk = '20464' --OSDE
AND hc.activa_sn = '1'
--and hc.nhc = '20864427'
ORDER BY CONVERT (VARCHAR, cagendas.fecha, 5) DESC, clientes.apellido1, clientes.nombre











--select * from INFORMATION_SCHEMA.COLUMNS where COLUMN_NAME = 'prest_item_pk' order by 3,4





--select * from vale_asis_det





--select * from vale_asis_det where prest_item_pk =2917


/*select * from cex where codigo_cliente = '40783'
select * from hc where nhc = '20864427'
select * from prest_item order by 4
select * from vale_asis_det where actividad_pk in ('1582640','1586232','1586350','1608347')


prest_item_pk = '2917' */



--select * from cagendas_prest where cagprest_nchipcard is not null





